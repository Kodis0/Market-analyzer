<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Market Analyzer</title>
  <style>
    :root {
      --bg: rgb(255, 0, 0);
      --bg-card: #16213e;
      --accent-jup: #00d9ff;
      --accent-bybit: #f7931a;
      --text: #e8e8e8;
      --text-dim: #8b8b9e;
      --border: #2a2a4a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
    }
    body { padding: 12px; padding-bottom: 24px; }

    .header {
      text-align: center;
      margin-bottom: 16px;
    }
    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
    }
    .header p {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 4px;
    }

    .period-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .period-tabs button {
      flex: 1;
      min-width: 60px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg-card);
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .period-tabs button:hover {
      background: var(--border);
    }
    .period-tabs button.active {
      background: var(--accent-jup);
      color: var(--bg);
      border-color: var(--accent-jup);
    }

    .chart-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }
    .chart-card h2 {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-dim);
    }
    .chart-wrap {
      width: 100%;
      height: 200px;
      position: relative;
    }
    .chart-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .legend {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      font-size: 0.8rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .legend-dot.jupiter { background: var(--accent-jup); }
    .legend-dot.bybit { background: var(--accent-bybit); }

    .loading, .error {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-dim);
    }
    .error { color: #ff6b6b; }

    .footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f5f5f7;
        --bg-card: #fff;
        --text: #1d1d1f;
        --text-dim: #6e6e73;
        --border: #d2d2d7;
      }
      .period-tabs button.active {
        color: #fff;
      }
    }
  </style>
</head>
<body>
  <div id="app" data-api-url="http://localhost:8080">
    <div class="header">
      <h1>Запросы Jupiter / Bybit</h1>
      <p>График активности API</p>
    </div>

    <div class="period-tabs">
      <button data-period="1h" class="active">Час</button>
      <button data-period="1d">День</button>
      <button data-period="1w">Неделя</button>
      <button data-period="all">Всё время</button>
    </div>

    <div class="chart-card">
      <h2>Количество запросов</h2>
      <div class="chart-wrap">
        <canvas id="chart" class="chart-canvas"></canvas>
      </div>
      <div class="legend">
        <span class="legend-item"><span class="legend-dot jupiter"></span> Jupiter</span>
        <span class="legend-item"><span class="legend-dot bybit"></span> Bybit</span>
      </div>
    </div>

    <div id="status" class="loading">Загрузка...</div>
    <div class="footer">
      API: <code id="api-display">—</code> • Обнови страницу для новых данных
    </div>
  </div>

  <script>
    (function() {
      const tg = window.Telegram?.WebApp;
      const startParam = tg?.startParam;
      const API_BASE = startParam
        ? decodeURIComponent(startParam)
        : (document.getElementById('app').dataset.apiUrl || 'http://localhost:8080');
      document.getElementById('api-display').textContent = API_BASE;

      let currentPeriod = '1h';
      const ctx = document.getElementById('chart').getContext('2d');

      function formatTime(ts, period) {
        const d = new Date(ts * 1000);
        if (period === '1h') return d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
        if (period === '1d') return d.getHours() + ':00';
        if (period === '1w' || period === 'all') return d.getDate() + '/' + (d.getMonth() + 1);
        return d.toLocaleTimeString();
      }

      function drawChart(data) {
        const w = ctx.canvas.width || 300;
        const h = ctx.canvas.height || 200;
        if (!data || data.length === 0) {
          ctx.fillStyle = '#8b8b9e';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Нет данных', w / 2, h / 2);
          return;
        }
        const padding = { top: 20, right: 40, bottom: 30, left: 50 };
        const chartW = w - padding.left - padding.right;
        const chartH = h - padding.top - padding.bottom;

        ctx.clearRect(0, 0, w, h);

        const jupMax = Math.max(1, ...data.map(d => d.jupiter || 0));
        const bybitMax = Math.max(1, ...data.map(d => d.bybit || 0));
        const yMax = Math.max(jupMax, bybitMax, 1);

        const jupColor = '#00d9ff';
        const bybitColor = '#f7931a';

        function drawLine(values, color, key) {
          const arr = data.map(d => d[key] || 0);
          ctx.beginPath();
          for (let i = 0; i < arr.length; i++) {
            const x = padding.left + (i / Math.max(1, arr.length - 1)) * chartW;
            const y = padding.top + chartH - (arr[i] / yMax) * chartH;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.lineJoin = 'round';
          ctx.lineCap = 'round';
          ctx.stroke();
        }

        drawLine(data, jupColor, 'jupiter');
        drawLine(data, bybitColor, 'bybit');

        // X labels
        ctx.fillStyle = '#8b8b9e';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        const step = Math.max(1, Math.floor(data.length / 5));
        for (let i = 0; i < data.length; i += step) {
          const x = padding.left + (i / Math.max(1, data.length - 1)) * chartW;
          ctx.fillText(formatTime(data[i].ts, currentPeriod), x, h - 8);
        }
      }

      async function fetchAndDraw() {
        const statusEl = document.getElementById('status');
        statusEl.className = 'loading';
        statusEl.textContent = 'Загрузка...';

        try {
          const r = await fetch(API_BASE + '/api/stats?period=' + currentPeriod);
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const data = await r.json();
          statusEl.className = '';
          statusEl.textContent = '';
          drawChart(data);
        } catch (e) {
          statusEl.className = 'error';
          statusEl.textContent = 'Ошибка: ' + e.message + '. Проверь API_URL и что бот запущен.';
          drawChart([]);
        }
      }

      document.querySelectorAll('.period-tabs button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelector('.period-tabs button.active').classList.remove('active');
          btn.classList.add('active');
          currentPeriod = btn.dataset.period;
          fetchAndDraw();
        });
      });

      const canvas = document.getElementById('chart');
      function resize() {
        const rect = canvas.getBoundingClientRect();
        if (rect.width && rect.height) {
          canvas.width = rect.width;
          canvas.height = rect.height;
        }
        fetchAndDraw();
      }
      window.addEventListener('resize', resize);
      resize();

      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
    })();
  </script>
</body>
</html>
