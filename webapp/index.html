<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Market Analyzer</title>
  <style>
    :root {
      --bg: #0d0d0f;
      --bg-card: #16161a;
      --bg-card-hover: #1c1c21;
      --accent-jup: #22d3ee;
      --accent-bybit: #f59e0b;
      --text: #f4f4f5;
      --text-dim: #71717a;
      --border: #27272a;
      --success: #22c55e;
      --error: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
    }
    body { padding: 16px; padding-bottom: 32px; }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header h1 {
      font-size: 1.35rem;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.02em;
    }
    .header p {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 6px;
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      margin-bottom: 20px;
    }
    .btn-refresh {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg-card);
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-refresh:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent-jup);
    }
    .btn-refresh svg {
      width: 18px;
      height: 18px;
    }
    .period-select {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg-card);
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      min-width: 140px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2371717a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }
    .period-select:hover {
      border-color: var(--text-dim);
    }

    .chart-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    .chart-card h2 {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 16px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .chart-wrap {
      width: 100%;
      height: 220px;
      position: relative;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
    }
    .chart-canvas {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 12px;
    }

    .legend {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      font-size: 0.85rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .legend-dot.jupiter { background: var(--accent-jup); }
    .legend-dot.bybit { background: var(--accent-bybit); }

    .stats-row {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .stat-badge {
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .stat-badge.jupiter { background: rgba(34, 211, 238, 0.15); color: var(--accent-jup); }
    .stat-badge.bybit { background: rgba(245, 158, 11, 0.15); color: var(--accent-bybit); }

    .status {
      text-align: center;
      padding: 16px;
      font-size: 0.9rem;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .status.loading {
      color: var(--text-dim);
      background: var(--bg-card);
      border: 1px dashed var(--border);
    }
    .status.error {
      color: var(--error);
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .status.success {
      color: var(--success);
      font-size: 0.8rem;
    }

    .footer {
      text-align: center;
      margin-top: 24px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }
    .footer code {
      background: var(--bg-card);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
    }

    .history-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      padding: 4px 0;
    }
    .history-header h2 {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .history-toggle {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      transition: transform 0.2s;
    }
    .history-card.expanded .history-toggle {
      transform: rotate(180deg);
    }
    .history-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .history-card.expanded .history-body {
      max-height: 500px;
    }
    .history-toolbar {
      display: flex;
      gap: 12px;
      margin: 16px 0 12px;
      align-items: center;
    }
    .history-period {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      appearance: none;
      min-width: 100px;
    }
    .history-list {
      list-style: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 6px;
      background: rgba(0,0,0,0.2);
      border: 1px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }
    .history-item:hover {
      background: var(--bg-card-hover);
      border-color: var(--border);
    }
    .history-item-token {
      font-weight: 600;
      color: var(--text);
      font-size: 0.95rem;
    }
    .history-item-direction {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 2px;
    }
    .history-item-profit {
      font-weight: 600;
      color: var(--success);
      font-size: 0.9rem;
    }
    .history-item-time {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 2px;
    }
    .history-empty {
      padding: 24px;
      text-align: center;
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #fafafa;
        --bg-card: #fff;
        --bg-card-hover: #f4f4f5;
        --text: #18181b;
        --text-dim: #52525b;
        --border: #e4e4e7;
      }
    }
  </style>
</head>
<body>
  <div id="app" data-api-url="https://api.arbmarketsystem.ru">
    <div class="header">
      <h1>Запросы Jupiter / Bybit</h1>
      <p>График активности API</p>
    </div>

    <div class="toolbar">
      <button type="button" class="btn-refresh" id="btn-refresh" title="Обновить">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        Refresh
      </button>
      <select class="period-select" id="period-select">
        <option value="1h">Last Hour</option>
        <option value="1d">Day</option>
        <option value="1w">Week</option>
        <option value="all">All time</option>
      </select>
    </div>

    <div class="chart-card">
      <h2>Количество запросов</h2>
      <div class="chart-wrap">
        <canvas id="chart" class="chart-canvas"></canvas>
      </div>
      <div class="legend">
        <span class="legend-item"><span class="legend-dot jupiter"></span> Jupiter</span>
        <span class="legend-item"><span class="legend-dot bybit"></span> Bybit</span>
      </div>
      <div id="stats-row" class="stats-row" style="display:none;"></div>
    </div>

    <div class="history-card" id="history-card">
      <div class="history-header" id="history-header">
        <h2>История сигналов</h2>
        <span class="history-toggle">▼</span>
      </div>
      <div class="history-body">
        <div class="history-toolbar">
          <select class="history-period" id="history-period">
            <option value="1h">Час</option>
            <option value="1d" selected>День</option>
            <option value="1w">Неделя</option>
            <option value="all">Всё время</option>
          </select>
        </div>
        <ul class="history-list" id="history-list"></ul>
      </div>
    </div>

    <div id="status" class="status loading">Загрузка...</div>
    <div class="footer">
      API: <code id="api-display">—</code> • Обнови страницу для новых данных
    </div>
  </div>

  <script>
    (function() {
      const params = new URLSearchParams(location.search);
      const tg = window.Telegram?.WebApp;
      const startParam = tg?.startParam;
      let rawApi = (params.get('api') ? decodeURIComponent(params.get('api')).trim() : null)
        || (startParam ? decodeURIComponent(startParam) : null)
        || (document.getElementById('app').dataset.apiUrl || 'http://localhost:8080');
      if (rawApi && !rawApi.match(/:\d+(\/|$)/)) {
        // Добавляем :8080 только для http (localhost, IP). Для https порт 443 по умолчанию
        if (!rawApi.startsWith('https://')) {
          rawApi = rawApi.replace(/:?\/?$/, '') + ':8080';
        } else {
          rawApi = rawApi.replace(/\/$/, '');
        }
      }
      const API_BASE = rawApi.replace(/\/$/, '');
      document.getElementById('api-display').textContent = API_BASE;

      let currentPeriod = '1h';
      const ctx = document.getElementById('chart').getContext('2d');

      function formatTime(ts, period) {
        const d = new Date(ts * 1000);
        if (period === '1h') return d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
        if (period === '1d') return d.getHours() + ':00';
        if (period === '1w' || period === 'all') return d.getDate() + '/' + (d.getMonth() + 1);
        return d.toLocaleTimeString();
      }

      function drawChart(data) {
        const w = ctx.canvas.width || 300;
        const h = ctx.canvas.height || 220;
        ctx.clearRect(0, 0, w, h);

        if (!data || data.length === 0) {
          ctx.fillStyle = '#71717a';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Нет данных', w / 2, h / 2);
          return;
        }

        const padding = { top: 24, right: 24, bottom: 32, left: 48 };
        const chartW = w - padding.left - padding.right;
        const chartH = h - padding.top - padding.bottom;

        const jupMax = Math.max(1, ...data.map(d => d.jupiter || 0));
        const bybitMax = Math.max(1, ...data.map(d => d.bybit || 0));
        const yMax = Math.max(jupMax, bybitMax, 1);

        const jupColor = '#22d3ee';
        const bybitColor = '#f59e0b';

        function drawLine(key, color) {
          const arr = data.map(d => d[key] || 0);
          ctx.beginPath();
          for (let i = 0; i < arr.length; i++) {
            const x = padding.left + (i / Math.max(1, arr.length - 1)) * chartW;
            const y = padding.top + chartH - (arr[i] / yMax) * chartH;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.strokeStyle = color;
          ctx.lineWidth = 2.5;
          ctx.lineJoin = 'round';
          ctx.lineCap = 'round';
          ctx.stroke();
        }

        drawLine('jupiter', jupColor);
        drawLine('bybit', bybitColor);

        ctx.fillStyle = '#71717a';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        const step = Math.max(1, Math.floor(data.length / 5));
        for (let i = 0; i < data.length; i += step) {
          const x = padding.left + (i / Math.max(1, data.length - 1)) * chartW;
          ctx.fillText(formatTime(data[i].ts, currentPeriod), x, h - 10);
        }
      }

      function updateStats(data) {
        const el = document.getElementById('stats-row');
        if (!data || data.length === 0) {
          el.style.display = 'none';
          return;
        }
        const totalJup = data.reduce((s, d) => s + (d.jupiter || 0), 0);
        const totalBybit = data.reduce((s, d) => s + (d.bybit || 0), 0);
        if (totalJup === 0 && totalBybit === 0) {
          el.style.display = 'none';
          return;
        }
        el.style.display = 'flex';
        el.innerHTML = '<span class="stat-badge jupiter">Jupiter: ' + totalJup + '</span><span class="stat-badge bybit">Bybit: ' + totalBybit + '</span>';
      }

      async function fetchAndDraw() {
        const statusEl = document.getElementById('status');
        statusEl.className = 'status loading';
        statusEl.textContent = 'Загрузка...';

        try {
          const r = await fetch(API_BASE.replace(/\/$/, '') + '/api/stats?period=' + currentPeriod);
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const data = await r.json();
          statusEl.className = 'status success';
          statusEl.textContent = 'Данные загружены';
          drawChart(data);
          updateStats(data);
        } catch (e) {
          statusEl.className = 'status error';
          statusEl.textContent = 'Ошибка: ' + e.message + '. Укажи ?api=http://IP:8080 в URL или проверь, что бот запущен и порт 8080 открыт.';
          drawChart([]);
          document.getElementById('stats-row').style.display = 'none';
        }
      }

      document.getElementById('btn-refresh').addEventListener('click', () => {
        fetchAndDraw();
        fetchSignalHistory();
      });
      document.getElementById('period-select').addEventListener('change', (e) => {
        currentPeriod = e.target.value;
        fetchAndDraw();
      });

      let historyPeriod = '1d';
      const historyCard = document.getElementById('history-card');
      const historyHeader = document.getElementById('history-header');
      const historyList = document.getElementById('history-list');

      historyHeader.addEventListener('click', () => {
        historyCard.classList.toggle('expanded');
        if (historyCard.classList.contains('expanded')) fetchSignalHistory();
      });

      document.getElementById('history-period').addEventListener('change', (e) => {
        historyPeriod = e.target.value;
        fetchSignalHistory();
      });

      function formatSignalTime(ts) {
        const d = new Date(ts * 1000);
        const now = new Date();
        const diff = Math.floor((now - d) / 1000);
        if (diff < 60) return 'только что';
        if (diff < 3600) return Math.floor(diff / 60) + ' мин назад';
        if (diff < 86400) return Math.floor(diff / 3600) + ' ч назад';
        return d.getDate() + '.' + (d.getMonth() + 1) + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
      }

      function formatDirection(dir) {
        if (dir === 'JUP->BYBIT') return 'Jupiter → Bybit';
        if (dir === 'BYBIT->JUP') return 'Bybit → Jupiter';
        return dir;
      }

      async function fetchSignalHistory() {
        historyList.innerHTML = '<li class="history-empty">Загрузка...</li>';
        try {
          const r = await fetch(API_BASE.replace(/\/$/, '') + '/api/signal-history?period=' + historyPeriod);
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const data = await r.json();
          if (!data || data.length === 0) {
            historyList.innerHTML = '<li class="history-empty">Нет сигналов за выбранный период</li>';
            return;
          }
          historyList.innerHTML = data.map(s => `
            <li class="history-item">
              <div>
                <div class="history-item-token">${escapeHtml(s.token)}</div>
                <div class="history-item-direction">${escapeHtml(formatDirection(s.direction))}</div>
              </div>
              <div style="text-align: right;">
                <div class="history-item-profit">+${Number(s.profit_usd).toFixed(2)}$</div>
                <div class="history-item-time">${formatSignalTime(s.ts)}</div>
              </div>
            </li>
          `).join('');
        } catch (e) {
          historyList.innerHTML = '<li class="history-empty">Ошибка загрузки: ' + escapeHtml(e.message) + '</li>';
        }
      }

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      const canvas = document.getElementById('chart');
      function resize() {
        const rect = canvas.getBoundingClientRect();
        if (rect.width && rect.height) {
          canvas.width = rect.width;
          canvas.height = rect.height;
        }
        fetchAndDraw();
      }
      window.addEventListener('resize', resize);
      resize();

      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
    })();
  </script>
</body>
</html>
